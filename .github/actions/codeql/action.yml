name: 'CodeQL'
description: 'Run CodeQL security analysis'

inputs:
  dotnet-version:
    description: '.NET version to setup'
    default: '10.0.x'
  configuration:
    description: 'Build configuration'
    default: 'Release'

runs:
  using: 'composite'
  steps:
  - uses: actions/checkout@v5
    with:
      lfs: true
      fetch-depth: 0

  - name: Initialize CodeQL
    uses: github/codeql-action/init@v3
    with:
      languages: csharp

  - name: Setup .NET
    uses: actions/setup-dotnet@v4
    with:
      dotnet-version: ${{ inputs.dotnet-version }}

  - name: Cache NuGet packages
    uses: actions/cache@v4
    with:
      path: ~/.nuget/packages
      key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
      restore-keys: |
        ${{ runner.os }}-nuget-

  - name: Restore dependencies
    shell: pwsh
    run: dotnet restore
    

  - name: Build
    shell: pwsh
    run: |
      $dotnetParams = @(
        "--no-restore",
        "/m:1",
        "--configuration", "${{ inputs.configuration }}"
      )

      dotnet build @dotnetParams

  - name: Perform CodeQL Analysis
    uses: github/codeql-action/analyze@v3