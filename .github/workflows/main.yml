# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Build and Test

on: [push, pull_request]

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest]
    runs-on: ${{matrix.os}}
    env:
      CONFIGURATION: Release

    steps:
    - uses: actions/checkout@v5
      with:
        lfs: true
        fetch-depth: 0
    
    - name: Docs Link Lint
      shell: pwsh
      run: |
        pwsh -NoLogo -NoProfile -ExecutionPolicy Bypass -File scripts/check-doc-links.ps1

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.2.0
      with:
        versionSpec: '6.4.x'

    - name: Determine Version
      id: version_step # step id used as a reference for output values
      uses: gittools/actions/gitversion/execute@v4.2.0

    - name: Set Version Environment Variables
      shell: pwsh
      run: |
        "AssemblyVersion=${{ steps.version_step.outputs.assemblySemVer }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        "AssemblyFileVersion=${{ steps.version_step.outputs.assemblySemFileVer }}" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Update Run Name
      shell: pwsh
      run: |
        $newTitle = "Build and Test v${{ steps.version_step.outputs.semVer }}"
        gh api -X PATCH /repos/${{ github.repository }}/actions/runs/${{ github.run_id }} -f display_title="$newTitle"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      shell: pwsh
      run: |
        $dotnetParams = @(
          "--no-restore",
          "/m:1",
          "--configuration", "$env:CONFIGURATION"
        )

        dotnet build @dotnetParams

    - name: Test
      shell: pwsh
      run: |
        $dotnetParams = @(
          "--no-build",
          "--configuration", "$env:CONFIGURATION",
          "--verbosity", "normal",
          "--collect:XPlat Code Coverage",
          "--logger", "trx",
          "--results-directory", "TestResults"
        )

        dotnet test @dotnetParams

    - name: Test Report
      uses: dorny/test-reporter@v2
      if: ${{ !cancelled() }}       # run this step even if previous step failed
      with:
        name: Unit Tests            # Name of the check run which will be created
        path: TestResults/**/*.trx        
        reporter: dotnet-trx        # Format of test results

    - name: ReportGenerator
      uses: danielpalme/ReportGenerator-GitHub-Action@5.5.1
      with:        
        reports: '**/coverage.cobertura.xml'
        targetdir: 'coverage'
        reporttypes: 'MarkdownSummaryGithub;MarkdownDeltaSummary'

    - name: Upload coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: CoverageReport-${{ steps.version_step.outputs.semVer }} # Artifact name        
        path: coverage 
        
    - name: Publish coverage in build summary
      run: cat coverage/SummaryGithub.md >> $env:GITHUB_STEP_SUMMARY # Adjust path and filename if necessary

    - name: Benchmark
      if: github.event_name == 'pull_request'
      shell: pwsh
      run: |
        $dotnetParams = @(
          "--no-build",
          "--configuration", "$env:CONFIGURATION",
          "--project", "TerrainGeneration2D.Benchmarks/TerrainGeneration2D.Benchmarks.csproj",
          "--filter", "*",
          "--verbosity", "normal",
          "--", 
          "--fast"
        )
        dotnet run @dotnetParams

    - name: Publish performance report in build summary
      if: github.event_name == 'pull_request'      
      run: cat BenchmarkDotNet.Artifacts/results/*.md >> $env:GITHUB_STEP_SUMMARY # Adjust path and filename if necessary
